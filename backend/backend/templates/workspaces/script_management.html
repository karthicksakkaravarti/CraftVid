{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Script Management" %} | {{ script.title }}{% endblock title %}

{% block extra_css %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<style>
  .CodeMirror {
    height: auto;
    min-height: 400px;
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  
  .CodeMirror-gutters {
    border-right: 1px solid #ddd;
  }
  
  .CodeMirror-linenumber {
    color: #888;
  }
  
  .cm-s-dracula .CodeMirror-cursor {
    border-left: 1px solid #f8f8f0;
  }
  
  .script-content-view {
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 14px;
    line-height: 1.6;
    padding: 1rem;
    border-radius: 0.375rem;
    background-color: #282a36;
    color: #f8f8f2;
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  .script-content-view pre {
    margin: 0;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  .script-content-view code {
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap: break-word;
  }
  
  .script-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    background-color: #f9fafb;
    border: 1px solid #ddd;
    border-bottom: none;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
  }
  
  .script-toolbar-title {
    font-weight: 600;
    color: #374151;
  }
  
  .script-toolbar-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .script-editor-container {
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .script-status {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .script-status-icon {
    margin-right: 0.25rem;
  }
  
  .hljs {
    background: #282a36 !important;
    padding: 0 !important;
    white-space: pre-wrap !important;
    word-break: break-word !important;
    overflow-wrap: break-word !important;
  }
  
  .json-key {
    color: #ff79c6;
  }
  
  .json-string {
    color: #f1fa8c;
  }
  
  .json-number {
    color: #bd93f9;
  }
  
  .json-boolean {
    color: #8be9fd;
  }
  
  .json-null {
    color: #6272a4;
  }
  
  /* Improved button styles */
  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 0.25rem;
    display: inline-flex;
    align-items: center;
    transition: all 0.2s;
  }
  
  .btn-secondary {
    background-color: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
  }
  
  .btn-secondary:hover {
    background-color: #e5e7eb;
  }
  
  .btn-primary {
    background-color: #4f46e5;
    color: white;
    border: 1px solid #4338ca;
  }
  
  .btn-primary:hover {
    background-color: #4338ca;
  }
  
  .btn-text {
    background-color: transparent;
    color: #6b7280;
    border: 1px solid transparent;
  }
  
  .btn-text:hover {
    background-color: #f3f4f6;
    color: #374151;
  }
  
  /* Save status styles */
  .save-status {
    display: inline-flex;
    align-items: center;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
  }
  
  .save-status-saving {
    background-color: #fef3c7;
    color: #92400e;
  }
  
  .save-status-saved {
    background-color: #d1fae5;
    color: #065f46;
  }
  
  .save-status-error {
    background-color: #fee2e2;
    color: #b91c1c;
  }

  /* Translation dropdown styles */
  .language-select {
    padding: 0.375rem 2rem 0.375rem 0.75rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    border: 1px solid #d1d5db;
    border-radius: 0.25rem;
    background-color: #fff;
    color: #374151;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }

  .language-select:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }

  .translate-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container py-8">
  <!-- Header -->
  <div class="flex justify-between items-start mb-8">
    <div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
        <a href="{% url 'workspaces:list' %}" class="hover:text-blue-600">
          {% translate "Workspaces" %}
        </a>
        <span>/</span>
        <a href="{% url 'workspaces:detail' workspace.id %}" class="hover:text-blue-600">
          {{ workspace.name }}
        </a>
        <span>/</span>
        <a href="{% url 'workspaces:script_list' workspace.id %}" class="hover:text-blue-600">
          {% translate "Scripts" %}
        </a>
        <span>/</span>
        <span>{{ script.title }}</span>
      </div>
      <h1 class="text-3xl font-bold text-gray-900">{{ script.title }}</h1>
      <div class="flex items-center gap-3 mt-1">
        <span class="px-2 py-1 text-xs font-medium rounded-full 
          {% if script.status == 'draft' %}bg-yellow-100 text-yellow-800{% endif %}
          {% if script.status == 'final' %}bg-green-100 text-green-800{% endif %}
          {% if script.status == 'archived' %}bg-gray-100 text-gray-800{% endif %}
        ">
          {{ script.get_status_display }}
        </span>
        <span class="text-sm text-gray-500">Version {{ script.version }}</span>
        <span class="text-sm text-gray-500">Created {{ script.created_at|date:"M d, Y" }}</span>
      </div>
    </div>
    <div class="flex gap-3">
      {% if script.status != 'final' %}
      <button id="finalizeBtn" class="btn-primary">
        {% translate "Finalize Script" %}
      </button>
      {% endif %}
      <button id="newVersionBtn" class="btn-secondary">
        {% translate "Create New Version" %}
      </button>
    </div>
  </div>

  <!-- Main content -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Script content -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-900">{% translate "Script Content" %}</h2>
          <div class="flex gap-2">
            <button id="editBtn" class="btn-sm btn-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
              </svg>
              {% translate "Edit" %}
            </button>
            <button id="saveBtn" class="btn-sm btn-primary hidden">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
              </svg>
              {% translate "Save" %}
            </button>
            <button id="cancelBtn" class="btn-sm btn-text hidden">
              {% translate "Cancel" %}
            </button>
            <span id="saveStatus" class="text-sm text-gray-500 hidden ml-2"></span>
          </div>
        </div>
        
        <!-- Script content (view mode) -->
        <div class="script-editor-container">
          <div class="script-toolbar">
                         <!-- Add translation controls -->
                         <div class="translate-group">
                          <select id="target-language" class="language-select">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="it">Italian</option>
                            <option value="pt">Portuguese</option>
                            <option value="nl">Dutch</option>
                            <option value="ru">Russian</option>
                            <option value="ja">Japanese</option>
                            <option value="zh">Chinese</option>
                            <option value="ko">Korean</option>
                            <option value="ar">Arabic</option>
                            <option value="hi">Hindi</option>
                            <option value="ta">Tamil</option>
                          </select>
                          <button id="translate-script" class="btn-sm btn-secondary" data-script-id="{{ script.id }}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/></svg>
                              {% translate "Translate" %}
                            </button>
                          </div>
            <div class="script-toolbar-title">{% translate "JSON Script" %}</div>
            <div class="script-toolbar-actions">
              <span class="text-xs text-gray-500" id="jsonValidStatus"></span>
            </div>
          </div>
          <div id="scriptContent" class="script-content-view">
            {{ script.content|linebreaks }}
          </div>
        </div>
        
        <!-- Script content (edit mode) -->
        <div id="scriptEditContainer" class="hidden script-editor-container">
          <div class="script-toolbar">
            <div class="script-toolbar-title">{% translate "Edit JSON Script" %}</div>
            <div class="script-toolbar-actions">
              <span id="editorStatus" class="text-xs text-gray-500"></span>
            </div>
          </div>
          <div id="scriptEditor"></div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="lg:col-span-1">
      <!-- Script details -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">{% translate "Script Details" %}</h3>
        <div class="space-y-4">
          <div>
            <h4 class="text-sm font-medium text-gray-500">{% translate "Topic" %}</h4>
            <p>{{ script.topic }}</p>
          </div>
          {% if script.audience %}
          <div>
            <h4 class="text-sm font-medium text-gray-500">{% translate "Target Audience" %}</h4>
            <p>{{ script.audience }}</p>
          </div>
          {% endif %}
          {% if script.tone %}
          <div>
            <h4 class="text-sm font-medium text-gray-500">{% translate "Tone" %}</h4>
            <p>{{ script.tone }}</p>
          </div>
          {% endif %}
          <div>
            <h4 class="text-sm font-medium text-gray-500">{% translate "Duration" %}</h4>
            <p>{{ script.duration }} seconds</p>
          </div>
          {% if script.additional_instructions %}
          <div>
            <h4 class="text-sm font-medium text-gray-500">{% translate "Additional Instructions" %}</h4>
            <p>{{ script.additional_instructions }}</p>
          </div>
          {% endif %}
          <div>
            <h4 class="text-sm font-medium text-gray-500">{% translate "Created By" %}</h4>
            <p>{{ script.created_by.name }}</p>
          </div>
        </div>
      </div>
      
      <!-- Screens -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold text-gray-900">{% translate "Screens" %}</h3>
          {% if script.screen_versions.all %}
          <a href="{% url 'workspaces:script_screens' workspace_id=workspace.id script_id=script.id %}" class="btn-outline-sm">
            {% translate "Manage All Screens" %}
          </a>
          {% endif %}
        </div>
        
        {% if script.screen_versions.all %}
          <div class="space-y-4">
            {% for screen in script.screen_versions.all %}
              <div class="border border-gray-200 rounded-md p-4">
                <div class="flex justify-between items-center mb-2">
                  <h4 class="text-md font-medium">{{ screen.name }}</h4>
                  <span class="px-2 py-1 text-xs rounded-full 
                    {% if screen.status == 'draft' %}bg-gray-100 text-gray-800{% endif %}
                    {% if screen.status == 'ready' %}bg-blue-100 text-blue-800{% endif %}
                    {% if screen.status == 'processing' %}bg-yellow-100 text-yellow-800{% endif %}
                    {% if screen.status == 'completed' %}bg-green-100 text-green-800{% endif %}
                    {% if screen.status == 'failed' %}bg-red-100 text-red-800{% endif %}">
                    {{ screen.get_status_display }}
                  </span>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                  <!-- Image status -->
                  <div class="flex items-center">
                    <span class="mr-2">{% translate "Images" %}:</span>
                    <span class="px-2 py-0.5 text-xs rounded-full 
                      {% if screen.status_data.images.status == 'pending' or not screen.status_data.images %}bg-gray-100 text-gray-800{% endif %}
                      {% if screen.status_data.images.status == 'processing' %}bg-yellow-100 text-yellow-800{% endif %}
                      {% if screen.status_data.images.status == 'completed' %}bg-green-100 text-green-800{% endif %}
                      {% if screen.status_data.images.status == 'failed' %}bg-red-100 text-red-800{% endif %}">
                      {% if screen.status_data.images.status %}
                        {{ screen.status_data.images.status }}
                      {% else %}
                        pending
                      {% endif %}
                    </span>
                  </div>
                  
                  <!-- Voice status -->
                  <div class="flex items-center">
                    <span class="mr-2">{% translate "Voices" %}:</span>
                    <span class="px-2 py-0.5 text-xs rounded-full 
                      {% if screen.status_data.voices.status == 'pending' or not screen.status_data.voices %}bg-gray-100 text-gray-800{% endif %}
                      {% if screen.status_data.voices.status == 'processing' %}bg-yellow-100 text-yellow-800{% endif %}
                      {% if screen.status_data.voices.status == 'completed' %}bg-green-100 text-green-800{% endif %}
                      {% if screen.status_data.voices.status == 'failed' %}bg-red-100 text-red-800{% endif %}">
                      {% if screen.status_data.voices.status %}
                        {{ screen.status_data.voices.status }}
                      {% else %}
                        pending
                      {% endif %}
                    </span>
                  </div>
                  
                  <!-- Video status -->
                  <div class="flex items-center">
                    <span class="mr-2">{% translate "Video" %}:</span>
                    <span class="px-2 py-0.5 text-xs rounded-full 
                      {% if screen.status_data.video.status == 'pending' or not screen.status_data.video %}bg-gray-100 text-gray-800{% endif %}
                      {% if screen.status_data.video.status == 'processing' %}bg-yellow-100 text-yellow-800{% endif %}
                      {% if screen.status_data.video.status == 'completed' %}bg-green-100 text-green-800{% endif %}
                      {% if screen.status_data.video.status == 'failed' %}bg-red-100 text-red-800{% endif %}">
                      {% if screen.status_data.video.status %}
                        {{ screen.status_data.video.status }}
                      {% else %}
                        pending
                      {% endif %}
                    </span>
                  </div>
                </div>
                
                <div class="flex justify-end">
                  <a href="{% url 'workspaces:screen_detail' workspace_id=workspace.id screen_id=screen.id %}" 
                     class="btn-primary-sm">
                    {% translate "Manage Screen" %}
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-4">
            <p class="text-gray-500">{% translate "No screens have been created yet." %}</p>
            <p class="text-gray-500 mt-2">{% translate "Finalize the script to create screens." %}</p>
          </div>
        {% endif %}
      </div>
      
      <!-- Version history -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">{% translate "Version History" %}</h3>
        <div class="space-y-3">
          {% for version in versions %}
          <a href="{% url 'workspaces:script_management' workspace.id version.id %}" 
             class="block p-3 rounded-md border {% if version.id == script.id %}border-blue-500 bg-blue-50{% else %}border-gray-200 hover:bg-gray-50{% endif %}">
            <div class="flex justify-between items-center">
              <div>
                <div class="font-medium">Version {{ version.version }}</div>
                <div class="text-sm text-gray-500">{{ version.created_at|date:"M d, Y H:i" }}</div>
              </div>
              <span class="px-2 py-1 text-xs font-medium rounded-full 
                {% if version.status == 'draft' %}bg-yellow-100 text-yellow-800{% endif %}
                {% if version.status == 'final' %}bg-green-100 text-green-800{% endif %}
                {% if version.status == 'archived' %}bg-gray-100 text-gray-800{% endif %}
              ">
                {{ version.get_status_display }}
              </span>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Next steps -->
<div class="bg-gray-50 border-t border-gray-200 py-8 mt-12">
  <div class="container">
    <h2 class="text-2xl font-bold text-gray-900 mb-6">{% translate "Next Steps" %}</h2>
    
    {% if script.screen_versions.exists %}
    <!-- Screen-based workflow -->
    {% with screen=script.screen_versions.first %}
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
      <div class="flex items-start">
        <div class="text-blue-600 mr-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-bold mb-2">{% translate "Screen Created" %}</h3>
          <p class="text-gray-600 mb-4">
            {% translate "A screen has been created for this script. You can now generate images, voices, and video from the screen detail page." %}
          </p>
          <a href="{% url 'workspaces:script_screens' workspace_id=workspace.id script_id=script.id %}" class="btn-primary inline-block">
            {% translate "Go to Screens" %}
          </a>
        </div>
      </div>
    </div>
    {% endwith %}
    {% else %}
    <!-- Legacy workflow -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <a href="{% url 'workspaces:image_editor' workspace.id script.id %}" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
        <div class="text-blue-600 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-bold mb-2">{% translate "Generate Images" %}</h3>
        <p class="text-gray-600">{% translate "Create visuals for your script using AI image generation." %}</p>
      </a>
      <a href="{% url 'workspaces:voice_editor' workspace.id script.id %}" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
        <div class="text-purple-600 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
        </div>
        <h3 class="text-lg font-bold mb-2">{% translate "Generate Voice-Over" %}</h3>
        <p class="text-gray-600">{% translate "Create voice-overs for your script using AI voice synthesis." %}</p>
      </a>
      <a href="{% url 'workspaces:video_editor' workspace.id script.id %}" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
        <div class="text-green-600 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-bold mb-2">{% translate "Create Video" %}</h3>
        <p class="text-gray-600">{% translate "Combine your script, images, and voice-over into a complete video." %}</p>
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Add modal for asset selection -->
<div id="assetSelectionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden" style="z-index: 100;">
  <div class="relative p-4 w-full max-w-2xl mx-auto h-full md:h-auto">
    <div class="relative bg-white rounded-lg shadow">
      <!-- Modal header -->
      <div class="flex justify-between items-center p-4 rounded-t border-b">
        <h3 class="text-xl font-semibold text-gray-900">
          {% translate "Select Assets to Import" %}
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="closeAssetModal()">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
      </div>
      <!-- Modal body -->
      <div class="p-6 space-y-6">
        <div class="mb-4">
          <label class="block text-gray-700 text-sm font-bold mb-2" for="sourceScript">
            {% translate "Source Script" %}
          </label>
          <select id="sourceScript" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <option value="">{% translate "Select a script" %}</option>
          </select>
        </div>
        <div class="space-y-4">
          <div class="flex items-center">
            <input id="importImages" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500">
            <label for="importImages" class="ml-2 text-sm font-medium text-gray-900">
              {% translate "Import Images" %}
            </label>
          </div>
          <div class="flex items-center">
            <input id="importVoices" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500">
            <label for="importVoices" class="ml-2 text-sm font-medium text-gray-900">
              {% translate "Import Voice-overs" %}
            </label>
          </div>
        </div>
      </div>
      <!-- Modal footer -->
      <div class="flex items-center p-6 space-x-2 rounded-b border-t border-gray-200">
        <button type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center" onclick="finalizeWithAssets()">
          {% translate "Finalize" %}
        </button>
        <button type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10" onclick="closeAssetModal()">
          {% translate "Cancel" %}
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/json-lint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>

<script>
    // Add workspace and script IDs to the global scope
    const workspaceId = '{{ workspace.id }}';
    const currentScriptId = '{{ script.id }}';
    
    console.log('Script Management page loaded');
    document.addEventListener('DOMContentLoaded', function() {
    const scriptContent = document.getElementById('scriptContent');
    const scriptEditContainer = document.getElementById('scriptEditContainer');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const finalizeBtn = document.getElementById('finalizeBtn');
    const newVersionBtn = document.getElementById('newVersionBtn');
    const saveStatus = document.getElementById('saveStatus');
    const jsonValidStatus = document.getElementById('jsonValidStatus');
    const editorStatus = document.getElementById('editorStatus');
    
    let autoSaveTimeout;
    // Properly handle the script content by wrapping it in JSON.parse
    let originalContent;
    try {
      originalContent = JSON.parse('{{ script.content|safe|escapejs }}');
      // Convert back to string for consistent handling
      originalContent = JSON.stringify(originalContent, null, 2);
      jsonValidStatus.textContent = '✓ Valid JSON';
      jsonValidStatus.classList.add('text-green-600');
    } catch (e) {
      // If it's not valid JSON, use it as a string
      originalContent = '{{ script.content|safe|escapejs }}';
      jsonValidStatus.textContent = '⚠ Invalid JSON';
      jsonValidStatus.classList.add('text-red-600');
      console.error('Error parsing script content as JSON:', e);
    }
    
    let lastSavedContent = originalContent;
    let isEditing = false;
    let codeMirrorEditor;
    
    // Initialize CodeMirror
    function initCodeMirror(content) {
      // If CodeMirror is already initialized, destroy it first
      if (codeMirrorEditor) {
        codeMirrorEditor.toTextArea();
      }
      
      // Create a textarea for CodeMirror
      const textarea = document.createElement('textarea');
      document.getElementById('scriptEditor').appendChild(textarea);
      
      // Initialize CodeMirror
      codeMirrorEditor = CodeMirror.fromTextArea(textarea, {
        mode: {
          name: "javascript",
          json: true
        },
        theme: "dracula",
        lineNumbers: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        indentUnit: 2,
        tabSize: 2,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
        lint: true,
        extraKeys: {
          "Ctrl-Space": "autocomplete",
          "Ctrl-Q": function(cm) { cm.foldCode(cm.getCursor()); }
        }
      });
      
      // Set content
      try {
        // If content is already a string, try to parse it to ensure it's valid JSON
        if (typeof content === 'string') {
          // Try to parse and format JSON
          const jsonObj = JSON.parse(content);
          const formattedJson = JSON.stringify(jsonObj, null, 2);
          codeMirrorEditor.setValue(formattedJson);
          editorStatus.textContent = '✓ Valid JSON';
          editorStatus.classList.add('text-green-600');
          editorStatus.classList.remove('text-red-600');
        } else {
          // If it's already an object, stringify it
          codeMirrorEditor.setValue(JSON.stringify(content, null, 2));
          editorStatus.textContent = '✓ Valid JSON';
          editorStatus.classList.add('text-green-600');
          editorStatus.classList.remove('text-red-600');
        }
      } catch (e) {
        // If not valid JSON, just set as is
        codeMirrorEditor.setValue(content.toString());
        editorStatus.textContent = '⚠ Invalid JSON';
        editorStatus.classList.add('text-red-600');
        editorStatus.classList.remove('text-green-600');
      }
      
      // Set up change event for auto-save and validation
      codeMirrorEditor.on('change', function() {
        handleEditorInput();
        
        // Validate JSON as user types
        try {
          JSON.parse(codeMirrorEditor.getValue());
          editorStatus.textContent = '✓ Valid JSON';
          editorStatus.classList.add('text-green-600');
          editorStatus.classList.remove('text-red-600');
        } catch (e) {
          editorStatus.textContent = '⚠ Invalid JSON: ' + e.message;
          editorStatus.classList.add('text-red-600');
          editorStatus.classList.remove('text-green-600');
        }
      });
      
      // Refresh to ensure proper rendering
      setTimeout(() => {
        codeMirrorEditor.refresh();
      }, 10);
    }
    
    // Edit mode
    editBtn.addEventListener('click', function() {
      enterEditMode();
    });
    
    // Function to enter edit mode
    function enterEditMode() {
      // Show edit mode
      scriptContent.parentElement.classList.add('hidden');
      scriptEditContainer.classList.remove('hidden');
      editBtn.classList.add('hidden');
      saveBtn.classList.remove('hidden');
      cancelBtn.classList.remove('hidden');
      saveStatus.classList.remove('hidden');
      saveStatus.textContent = '{% translate "Ready to edit" %}';
      saveStatus.className = 'save-status';
      isEditing = true;
      
      // Initialize CodeMirror
      initCodeMirror(originalContent);
      
      // Set up auto-save
      // (Now handled by CodeMirror's change event)
    }
    
    // Handle editor input with debounced auto-save
    function handleEditorInput() {
      saveStatus.textContent = '{% translate "Editing..." %}';
      saveStatus.className = 'save-status';
      
      // Clear previous timeout
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      
      // Set new timeout for auto-save
      autoSaveTimeout = setTimeout(function() {
        const currentContent = codeMirrorEditor.getValue();
        if (currentContent !== lastSavedContent) {
          autoSave();
        }
      }, 2000); // Auto-save after 2 seconds of inactivity
    }
    
    // Auto-save function
    function autoSave() {
      const content = codeMirrorEditor.getValue();
      
      // Don't save if content hasn't changed
      if (content === lastSavedContent) {
        return;
      }
      
      saveStatus.textContent = '{% translate "Saving..." %}';
      saveStatus.className = 'save-status save-status-saving';
      
      // Send update request
      fetch('{% url "workspaces:script_update" workspace.id script.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
          'content': content,
          'create_new_version': 'false'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update the view (but don't exit edit mode)
          lastSavedContent = content;
          
          // Update save status
          saveStatus.textContent = '{% translate "Saved" %}';
          saveStatus.className = 'save-status save-status-saved';
          
          // Update the hidden view content for when we exit edit mode
          updateViewContent(content);
        } else {
          saveStatus.textContent = '{% translate "Error saving" %}';
          saveStatus.className = 'save-status save-status-error';
          console.error('Error:', data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        saveStatus.textContent = '{% translate "Error saving" %}';
        saveStatus.className = 'save-status save-status-error';
      });
    }
    
    // Function to update the view content with formatted JSON
    function updateViewContent(content) {
      try {
        // Try to display formatted JSON
        const jsonObj = JSON.parse(content);
        const formattedJson = JSON.stringify(jsonObj, null, 2);
        
        // Format with syntax highlighting
        const highlighted = formatJsonWithHighlighting(formattedJson);
        scriptContent.innerHTML = highlighted;
        
        // Ensure all code elements have proper wrapping
        const codeElements = scriptContent.querySelectorAll('code');
        codeElements.forEach(el => {
          el.style.whiteSpace = 'pre-wrap';
          el.style.wordBreak = 'break-word';
          el.style.overflowWrap = 'break-word';
        });
        
        // Update JSON validation status
        jsonValidStatus.textContent = '✓ Valid JSON';
        jsonValidStatus.classList.add('text-green-600');
        jsonValidStatus.classList.remove('text-red-600');
      } catch (e) {
        // If not valid JSON, just use linebreaks
        scriptContent.innerHTML = content.replace(/\n/g, '<br>');
        
        // Update JSON validation status
        jsonValidStatus.textContent = '⚠ Invalid JSON';
        jsonValidStatus.classList.add('text-red-600');
        jsonValidStatus.classList.remove('text-green-600');
      }
    }
    
    // Function to format JSON with syntax highlighting
    function formatJsonWithHighlighting(jsonString) {
      // Create a pre element with the hljs class
      const preElement = document.createElement('pre');
      preElement.className = 'language-json';
      preElement.style.whiteSpace = 'pre-wrap';
      preElement.style.wordBreak = 'break-word';
      
      // Create a code element
      const codeElement = document.createElement('code');
      codeElement.className = 'language-json';
      codeElement.style.whiteSpace = 'pre-wrap';
      codeElement.style.wordBreak = 'break-word';
      codeElement.textContent = jsonString;
      
      // Append the code element to the pre element
      preElement.appendChild(codeElement);
      
      // Apply highlight.js highlighting
      hljs.highlightElement(codeElement);
      
      return preElement.outerHTML;
    }
    
    // Cancel edit
    cancelBtn.addEventListener('click', function() {
      exitEditMode(true);
    });
    
    // Save changes manually
    saveBtn.addEventListener('click', function() {
      const content = codeMirrorEditor.getValue();
      
      // Show loading state
      saveBtn.disabled = true;
      saveBtn.innerHTML = '{% translate "Saving..." %}';
      
      // Send update request
      fetch('{% url "workspaces:script_update" workspace.id script.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
          'content': content,
          'create_new_version': 'false'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update the view
          lastSavedContent = content;
          
          // Update the content display
          updateViewContent(content);
          
          // Exit edit mode
          exitEditMode(false);
          
          // Show success message in status instead of alert
          saveStatus.textContent = '{% translate "Saved successfully" %}';
          saveStatus.className = 'save-status save-status-saved';
          saveStatus.classList.remove('hidden');
          
          // Hide status message after 3 seconds
          setTimeout(function() {
            saveStatus.classList.add('hidden');
          }, 3000);
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving the script.');
      })
      .finally(() => {
        // Reset button state
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> {% translate "Save" %}';
      });
    });
    
    // Function to exit edit mode
    function exitEditMode(revert) {
      // Clear any pending auto-save
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      
      // If reverting, reset to original content
      if (revert) {
        // No need to set editor content as we're destroying it
        
        // Reset the view content
        updateViewContent(lastSavedContent);
      }
      
      // Switch back to view mode
      scriptContent.parentElement.classList.remove('hidden');
      scriptEditContainer.classList.add('hidden');
      editBtn.classList.remove('hidden');
      saveBtn.classList.add('hidden');
      cancelBtn.classList.add('hidden');
      saveStatus.classList.add('hidden');
      isEditing = false;
      
      // Clean up CodeMirror
      if (codeMirrorEditor) {
        codeMirrorEditor.toTextArea();
        codeMirrorEditor = null;
      }
      
      // Clear the editor container
      document.getElementById('scriptEditor').innerHTML = '';
    }
    
    // Create new version
    newVersionBtn.addEventListener('click', function() {
      if (confirm('{% translate "Create a new version of this script?" %}')) {
        // If currently editing, use the editor content
        const content = isEditing ? codeMirrorEditor.getValue() : lastSavedContent;
        
        // Show loading state
        newVersionBtn.disabled = true;
        newVersionBtn.innerHTML = '{% translate "Creating..." %}';
        
        // Send update request with new version flag
        fetch('{% url "workspaces:script_update" workspace.id script.id %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: new URLSearchParams({
            'content': content,
            'create_new_version': 'true'
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Redirect to the new version using the redirect_url provided by the server
            if (data.redirect_url) {
              window.location.href = data.redirect_url;
            } else if (data.script_id) {
              // Fallback if redirect_url is not provided
              window.location.href = `/workspaces/${workspace.id}/scripts/${data.script_id}/`;
            } else {
              // If no script_id is provided, go back to the script list
              window.location.href = '{% url "workspaces:script_list" workspace.id %}';
            }
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while creating a new version.');
        })
        .finally(() => {
          // Reset button state
          newVersionBtn.disabled = false;
          newVersionBtn.innerHTML = '{% translate "Create New Version" %}';
        });
      }
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl+E or Cmd+E to toggle edit mode
      if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        if (isEditing) {
          exitEditMode(false);
        } else {
          enterEditMode();
        }
      }
      
      // Ctrl+S or Cmd+S to save
      if ((e.ctrlKey || e.metaKey) && e.key === 's' && isEditing) {
        e.preventDefault();
        saveBtn.click();
      }
      
      // Escape to cancel edit
      if (e.key === 'Escape' && isEditing) {
        e.preventDefault();
        if (confirm('{% translate "Exit edit mode? Any unsaved changes will be lost." %}')) {
          exitEditMode(true);
        }
      }
    });
    
    // Initialize the view with formatted JSON
    updateViewContent(originalContent);

    const translateBtn = document.getElementById('translate-script');
    const targetLanguageSelect = document.getElementById('target-language');
    
    translateBtn.addEventListener('click', async function() {
      const scriptId = this.dataset.scriptId;
      const targetLanguage = targetLanguageSelect.value;
      
      try {
        translateBtn.disabled = true;
        translateBtn.innerHTML = '<svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Translating...';
        const response = await fetch(`{% url "workspaces:script_translate" workspace.id script.id %}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            target_language: targetLanguage
          })
        });
        
        if (!response.ok) {
          throw new Error('Translation failed');
        }
        
        const result = await response.json();
        if (result.success) {
          window.location.href = result.redirect_url;
        } else {
          throw new Error(result.error || 'Translation failed');
        }
        
      } catch (error) {
        console.error('Translation error:', error);
        alert('Failed to translate script: ' + error.message);
      } finally {
        translateBtn.disabled = false;
        translateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/></svg>Translate';
      }
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function showAssetModal() {
      // Fetch available scripts in the workspace
      fetch(`/workspaces/api/workspaces/${workspaceId}/scripts/list-all/`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch scripts');
          }
          return response.json();
        })
        .then(data => {
          const select = document.getElementById('sourceScript');
          select.innerHTML = '<option value="">{% translate "Select a script" %}</option>';
          
          data.forEach(script => {
            if (script.id !== currentScriptId && script.status === 'final') {
              const option = document.createElement('option');
              option.value = script.id;
              option.textContent = script.title;
              select.appendChild(option);
            }
          });
          
          document.getElementById('assetSelectionModal').classList.remove('hidden');
        })
        .catch(error => {
          console.error('Error fetching scripts:', error);
          alert(`{% translate "Failed to load scripts" %}: ${error.message}`);
        });
    }

    function closeAssetModal() {
      document.getElementById('assetSelectionModal').classList.add('hidden');
    }

    function finalizeWithAssets() {
      const sourceScriptId = document.getElementById('sourceScript').value;
      const importImages = document.getElementById('importImages').checked;
      const importVoices = document.getElementById('importVoices').checked;
      
      // Show loading state
      const finalizeModalBtn = document.querySelector('#assetSelectionModal button.bg-blue-700');
      finalizeModalBtn.disabled = true;
      finalizeModalBtn.innerHTML = '{% translate "Finalizing..." %}';
      
      fetch(`{% url "workspaces:script_finalize" workspace.id script.id %}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          source_script_id: sourceScriptId,
          import_images: importImages,
          import_voices: importVoices
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = data.redirect_url;
        } else {
          alert(data.error || '{% translate "Failed to finalize script" %}');
          finalizeModalBtn.disabled = false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('{% translate "An error occurred while finalizing the script" %}');
      });
    }

    // Finalize script
    if (finalizeBtn) {
      finalizeBtn.addEventListener('click', function() {
        // If currently editing, save first
        if (isEditing) {
          if (codeMirrorEditor.getValue() !== lastSavedContent) {
            if (!confirm('{% translate "You have unsaved changes. Save before finalizing?" %}')) {
              return;
            }
            autoSave();
          }
        }
        
        // Show the asset selection modal
        if (confirm('{% translate "Are you sure you want to finalize this script? This will create screens for each scene." %}')) {
          showAssetModal();
        }
      });
    }

    // Add click event handlers for modal buttons after the DOM is fully loaded
    const modalFinalizeBtn = document.querySelector('#assetSelectionModal button.bg-blue-700');
    if (modalFinalizeBtn) {
        modalFinalizeBtn.addEventListener('click', finalizeWithAssets);
        // Remove the onclick attribute for cleaner code
        modalFinalizeBtn.removeAttribute('onclick');
    }
    
    const modalCancelBtns = document.querySelectorAll('#assetSelectionModal button.bg-white, #assetSelectionModal button.text-gray-400');
    modalCancelBtns.forEach(btn => {
        btn.addEventListener('click', closeAssetModal);
        // Remove the onclick attribute for cleaner code
        btn.removeAttribute('onclick');
    });
  });
</script>
{% endblock extra_js %} 